<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: components/MerakiUsers/index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: components/MerakiUsers/index.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import React, { useEffect, useState } from "react";
import axios from "axios";
import { useSelector } from "react-redux";
import { BsArrowUpDown } from "react-icons/bs";
import { METHODS } from "../../services/api";
import { useDebounce } from "use-debounce";
import ReactPaginate from "react-paginate";
import moment from "moment";
import Slider from "rc-slider";
import "rc-slider/assets/index.css";
import "./styles.scss";

const { createSliderWithTooltip } = Slider;
const Range = createSliderWithTooltip(Slider.Range);

const getPartnerIdFromUrl = () => {
  let partnerId;
  if (window.location.pathname.includes("partner")) {
    partnerId = window.location.pathname.split("/").pop();
  }
  return partnerId;
};

function MerakiUsers() {
  const [pageNumber, setPageNumber] = useState(0);
  const [totalCount, setTotalCount] = useState();
  const [message, setMessage] = useState("");
  const [students, setStudents] = useState([]);
  const [slicedStudents, setSlicedStudents] = useState([]);
  const [searchTerm, setSearchTerm] = useState("");
  const [sortMethod, setSortMethod] = useState("dsc");
  const [sort_class, setSortClass] = useState("sorter");
  const [filterVal, setFilterVal] = useState([0, 0]);
  const [filteredData, setFilteredData] = useState(false);
  const [debouncedText] = useDebounce(searchTerm, 400);

  const user = useSelector(({ User }) => User);

  const limit = 10;
  let id = getPartnerIdFromUrl();
  useEffect(() => {
    // let id = getPartnerIdFromUrl();
    axios({
      method: METHODS.GET,
      url: `${process.env.REACT_APP_MERAKI_URL}/users/students/classes${
        searchTerm.length > 0 ? `?name=${searchTerm}` : ""
      }`,
      headers: { accept: "application/json", Authorization: user.data.token },
    }).then((res) => {
      if (
        id == user.data.user.partner_id ||
        user.data.user.rolesList.indexOf("admin") > -1
      ) {
        if (res.data.students.length &lt; 1) {
          setMessage("There are no results to display");
        } else {
          const data = res.data.students
            .map((item) => {
              if (item.classes_registered.length > 0) {
                item.averageRating = 0;
                let avg = 0;
                let count = 0;
                item.classes_registered.map((f) => {
                  if (f.feedback.feedback) {
                    avg = avg + parseInt(f.feedback.feedback);
                    count += 1;
                  }
                });
                if (avg > 0) item.averageRating = avg / count;
                else item.averageRating = avg;
                item.classes_registered = item.classes_registered.sort(
                  (c1, c2) => {
                    return new Date(c1.start_time) - new Date(c2.start_time);
                  }
                );
              }
              return {
                ...item,
                // not overwriting original created_at because we need the date object to sort by date
                formatted_created_at: item.created_at
                  ? moment(item.created_at.replace("Z", "")).format(
                      "DD-MM-YYYY"
                    )
                  : "",
                classes_registered: item.classes_registered.map((item) => {
                  return {
                    ...item,
                    formatted_start_time: item.start_time
                      ? moment(item.start_time.replace("Z", "")).format(
                          "DD-MM-YYYY"
                        )
                      : "",
                    /**
                     * REVIEW
                     * Why item is there again in the next line?
                     */
                    item,
                    formatted_end_time: item.end_time
                      ? moment(item.end_time.replace("Z", "")).format("hh:mm a")
                      : "",
                  };
                }),
              };
            })
            .sort((a, b) => {
              return a.name.localeCompare(b.name);
            });
          setStudents(data);
          setSlicedStudents(
            data.slice(pageNumber * limit, (pageNumber + 1) * limit)
          );
          setTotalCount(res.data.count);
        }
      }
    });
  }, [debouncedText]);

  const pageCount = Math.ceil(totalCount / limit);
  const changePage = ({ selected }) => {
    setPageNumber(selected);
  };

  const sortStudents = (byMethod) => {
    const students = filteredData ? filter : students;
    let sortedStudents;
    if (byMethod === "name") {
      sortedStudents = students.sort().reverse();
    } else if (byMethod === "enroll_date") {
      sortedStudents = students.sort((a, b) =>
        sortMethod === "asc"
          ? new Date(a.created_at) - new Date(b.created_at)
          : new Date(b.created_at) - new Date(a.created_at)
      );
    } else if (byMethod === "total_classes") {
      sortedStudents = students.sort((a, b) =>
        sortMethod === "asc"
          ? a.classes_registered.length - b.classes_registered.length
          : b.classes_registered.length - a.classes_registered.length
      );
    } else if (byMethod === "last_class_title") {
      const zeroClass = students.filter((a) => {
        return a.classes_registered.length &lt;= 0;
      });
      sortedStudents = students
        .filter((a) => {
          return a.classes_registered.length > 0;
        })
        .sort((a, b) => {
          return sortMethod === "asc"
            ? a.classes_registered[
                a.classes_registered.length - 1
              ].title.localeCompare(
                b.classes_registered[b.classes_registered.length - 1].title
              )
            : b.classes_registered[
                b.classes_registered.length - 1
              ].title.localeCompare(
                a.classes_registered[a.classes_registered.length - 1].title
              );
        });
      sortedStudents = [...sortedStudents, ...zeroClass];
    } else if (byMethod === "last_class_date") {
      const zeroClass = students.filter((a) => {
        return a.classes_registered.length &lt;= 0;
      });
      sortedStudents = students
        .filter((a) => {
          if (a.classes_registered.length > 0) {
            a.classes_registered = a.classes_registered.sort((c1, c2) => {
              return new Date(c1.start_time) - new Date(c2.start_time);
            });
            return a;
          }
        })
        .sort((a, b) => {
          const startTimeOfA = [];
          const startTimeOfB = [];
          a.classes_registered.forEach((c) =>
            startTimeOfA.push(new Date(c.start_time))
          );
          b.classes_registered.forEach((c) =>
            startTimeOfB.push(new Date(c.start_time))
          );
          return sortMethod === "asc"
            ? Math.max(...startTimeOfA) - Math.max(...startTimeOfB)
            : Math.max(...startTimeOfB) - Math.max(...startTimeOfA);
        });
      sortedStudents = [...sortedStudents, ...zeroClass];
    } else if (byMethod === "rating") {
      const zeroClass = students.filter((a) => {
        return a.classes_registered.length &lt;= 0;
      });
      sortedStudents = students.sort((a, b) => {
        return sortMethod === "asc"
          ? a.averageRating - b.averageRating
          : b.averageRating - a.averageRating;
      });
      sortedStudents = [...sortedStudents, ...zeroClass];
    }
    setStudents(sortedStudents);
    setSlicedStudents(
      sortedStudents.slice(pageNumber * limit, (pageNumber + 1) * limit)
    );
    if (sortMethod === "asc") {
      setSortClass("sorter");
      setSortMethod("dsc");
    } else {
      setSortClass("sorter turn");
      setSortMethod("asc");
    }
  };

  const handleChange = (value) => {
    setFilteredData(true);
    setFilterVal(value);
  };

  let filter = [];
  students.filter((item) => {
    if (filterVal[0] === 0) {
      if (item.classes_registered.length === 0) {
        filter.push(item);
      }
    } else if (filterVal[0] === 30) {
      if (item.classes_registered.length >= 30) {
        filter.push(item);
      }
    } else {
      const range = (min, max) =>
        Array.from({ length: max - min + 1 }, (_, i) => min + i);
      range(filterVal[0], filterVal[1]).map((range) => {
        if (item.classes_registered.length === range) {
          filter.push(item);
        }
      });
    }
  });

  useEffect(() => {
    if (filteredData) {
      const slicedData = filter.slice(
        pageNumber * limit,
        (pageNumber + 1) * limit
      );
      setSlicedStudents(slicedData);
    } else {
      const slicedData = students.slice(
        pageNumber * limit,
        (pageNumber + 1) * limit
      );
      setSlicedStudents(slicedData);
    }
  }, [pageNumber, filterVal]);

  return (
    &lt;div className="container-table">
      &lt;div className="container-for-search">
        &lt;div>
          &lt;input
            className="Search-bar"
            type="text"
            placeholder="Search by student Name class"
            value={searchTerm}
            onChange={(e) => {
              setSearchTerm(e.target.value);
            }}
          />
        &lt;/div>
        &lt;div className="last-item">
          &lt;ReactPaginate
            previousLabel={&lt;i className="fa fa-angle-left">&lt;/i>}
            nextLabel={&lt;i className="fa fa-angle-right">&lt;/i>}
            initialPage={0}
            marginPagesDisplayed={0}
            onPageChange={changePage}
            pageCount={pageCount}
            containerClassName="paginationBttns"
            previousLinkClassName="previousBttn"
            nextLinkClassName="nextBttn"
            disabledClassName="paginationDisabled"
            activeClassName="paginationActive"
          />
        &lt;/div>
      &lt;/div>
      &lt;div className="slider-label">
        &lt;label>Total attended classes &lt;/label>
        &lt;div className="slider">
          &lt;Range
            min={0}
            max={40}
            defaultValue={[0, 0]}
            step={null}
            tipFormatter={(value) => (value === 40 ? (value = "30+") : value)}
            value={filterVal}
            onChange={handleChange}
            marks={{
              0: 0,
              1: 1,
              6: 6,
              10: 10,
              15: 15,
              20: 20,
              25: 25,
              30: 30,
              40: `${30}+`,
            }}
          />
        &lt;/div>
        &lt;button
          onClick={() => {
            setFilteredData(false);
            setFilterVal([0, 0]);
          }}
          className="filter-clear"
        >
          clear
        &lt;/button>
      &lt;/div>
      &lt;table className="student-overview-table">
        &lt;thead>
          &lt;tr>
            &lt;th className="student-name">
              Students Name
              &lt;button
                className={sort_class}
                onClick={() => sortStudents("name")}
              >
                &lt;BsArrowUpDown />
              &lt;/button>
            &lt;/th>
            &lt;th className="student-name">
              Partner Name
              {/* &lt;button
                className={sort_class}
                onClick={() => sortStudents("name")}
              >
                &lt;BsArrowUpDown />
              &lt;/button> */}
            &lt;/th>

            &lt;th>
              Enroll date
              &lt;button
                className={sort_class}
                onClick={() => sortStudents("enroll_date")}
              >
                &lt;BsArrowUpDown />
              &lt;/button>
            &lt;/th>
            &lt;th>
              Classes Attended
              &lt;button
                className={sort_class}
                onClick={() => sortStudents("total_classes")}
              >
                &lt;BsArrowUpDown />
              &lt;/button>
            &lt;/th>
            &lt;th>
              Last Class Title
              &lt;button
                className={sort_class}
                onClick={() => sortStudents("last_class_title")}
              >
                &lt;BsArrowUpDown />
              &lt;/button>
            &lt;/th>
            &lt;th>
              Last Class Date
              &lt;button
                className={sort_class}
                onClick={() => sortStudents("last_class_date")}
              >
                &lt;BsArrowUpDown />
              &lt;/button>
            &lt;/th>
            &lt;th>Last Class Time&lt;/th>
            &lt;th>
              Average Rating
              &lt;button
                className={sort_class}
                onClick={() => sortStudents("rating")}
              >
                &lt;BsArrowUpDown />
              &lt;/button>
            &lt;/th>
          &lt;/tr>
        &lt;/thead>
        &lt;tbody>
          {filteredData
            ? slicedStudents.map((item) => {
                let getStars = 0;
                let totalStarts = item.classes_registered.length * 5;
                item.classes_registered.map((stars) => {
                  getStars = getStars + Number(stars.feedback.feedback);
                });
                return (
                  &lt;tr key={item.id}>
                    &lt;td data-column="Name">{item.name}&lt;/td>

                    &lt;td data-column="Partner">
                      {item.partner ? item.partner.name : "NA"}
                    &lt;/td>

                    &lt;td data-column="Enrolled On">
                      {item.formatted_created_at}
                    &lt;/td>
                    &lt;td data-column="Total classes ">
                      {" "}
                      {item.classes_registered.length}
                    &lt;/td>

                    &lt;td data-column="Last class title">
                      {item.classes_registered &amp;&amp;
                      item.classes_registered.length > 0 &amp;&amp;
                      item.classes_registered[
                        item.classes_registered.length - 1
                      ]["title"] != ""
                        ? item.classes_registered[
                            item.classes_registered.length - 1
                          ]["title"]
                        : "NA"}
                    &lt;/td>
                    &lt;td data-column="Last class date">
                      {item.classes_registered &amp;&amp;
                      item.classes_registered.length > 0 &amp;&amp;
                      item.classes_registered[
                        item.classes_registered.length - 1
                      ]["formatted_start_time"]
                        ? item.classes_registered[
                            item.classes_registered.length - 1
                          ]["formatted_start_time"]
                        : "NA"}
                    &lt;/td>
                    &lt;td data-column="Last class time">
                      {item.classes_registered &amp;&amp;
                      item.classes_registered.length > 0 &amp;&amp;
                      item.classes_registered[
                        item.classes_registered.length - 1
                      ]["formatted_end_time"]
                        ? item.classes_registered[
                            item.classes_registered.length - 1
                          ]["formatted_end_time"]
                        : "NA"}
                    &lt;/td>
                    &lt;td data-column="Avg rating ">
                      {[1, 2, 3, 4, 5].map((star) => {
                        return Math.ceil(item.averageRating) > 0 &amp;&amp;
                          star &lt;= Math.ceil(item.averageRating) ? (
                          &lt;span
                            className="fa fa-star"
                            style={{ color: "#D55F31" }}
                          >&lt;/span>
                        ) : (
                          &lt;span
                            className="fa fa-star"
                            style={{ color: "gray" }}
                          >&lt;/span>
                        );
                      })}
                    &lt;/td>
                  &lt;/tr>
                );
              })
            : slicedStudents.map((item) => {
                let getStars = 0;
                let totalStarts = item.classes_registered.length * 5;
                item.classes_registered.map((stars) => {
                  getStars = getStars + Number(stars.feedback.feedback);
                });
                return (
                  &lt;tr key={item.id}>
                    &lt;td data-column="Name">{item.name}&lt;/td>

                    &lt;td data-column="Partner">
                      {item.partner ? item.partner.name : "NA"}
                    &lt;/td>

                    &lt;td data-column="Enrolled On">
                      {item.formatted_created_at}
                    &lt;/td>
                    &lt;td data-column="Total classes ">
                      {" "}
                      {item.classes_registered.length}
                    &lt;/td>

                    &lt;td data-column="Last class title">
                      {item.classes_registered &amp;&amp;
                      item.classes_registered.length > 0 &amp;&amp;
                      item.classes_registered[
                        item.classes_registered.length - 1
                      ]["title"] != ""
                        ? item.classes_registered[
                            item.classes_registered.length - 1
                          ]["title"]
                        : "NA"}
                    &lt;/td>
                    &lt;td data-column="Last class date">
                      {item.classes_registered &amp;&amp;
                      item.classes_registered.length > 0 &amp;&amp;
                      item.classes_registered[
                        item.classes_registered.length - 1
                      ]["formatted_start_time"]
                        ? item.classes_registered[
                            item.classes_registered.length - 1
                          ]["formatted_start_time"]
                        : "NA"}
                    &lt;/td>
                    &lt;td data-column="Last class time">
                      {item.classes_registered &amp;&amp;
                      item.classes_registered.length > 0 &amp;&amp;
                      item.classes_registered[
                        item.classes_registered.length - 1
                      ]["formatted_end_time"]
                        ? item.classes_registered[
                            item.classes_registered.length - 1
                          ]["formatted_end_time"]
                        : "NA"}
                    &lt;/td>
                    &lt;td data-column="Avg rating ">
                      {[1, 2, 3, 4, 5].map((star) => {
                        return Math.ceil(item.averageRating) > 0 &amp;&amp;
                          star &lt;= Math.ceil(item.averageRating) ? (
                          &lt;span
                            className="fa fa-star"
                            style={{ color: "#D55F31" }}
                          >&lt;/span>
                        ) : (
                          &lt;span
                            className="fa fa-star"
                            style={{ color: "gray" }}
                          >&lt;/span>
                        );
                      })}
                    &lt;/td>
                  &lt;/tr>
                );
              })}
          {message ? &lt;h1 className="Message">{message}&lt;/h1> : null}
        &lt;/tbody>
      &lt;/table>
    &lt;/div>
  );
}

export default MerakiUsers;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="SearchService.html">SearchService</a></li></ul><h3>Global</h3><ul><li><a href="global.html#ErrorHandler">ErrorHandler</a></li><li><a href="global.html#FutureOrPast">FutureOrPast</a></li><li><a href="global.html#HeaderFactory">HeaderFactory</a></li><li><a href="global.html#METHODS">METHODS</a></li><li><a href="global.html#dateTimeFormat">dateTimeFormat</a></li><li><a href="global.html#differenceInMilliseconds">differenceInMilliseconds</a></li><li><a href="global.html#differenceInMinutes">differenceInMinutes</a></li><li><a href="global.html#format">format</a></li><li><a href="global.html#formatInTimeZone">formatInTimeZone</a></li><li><a href="global.html#getAllClasses">getAllClasses</a></li><li><a href="global.html#getCourseContent">getCourseContent</a></li><li><a href="global.html#getCourses">getCourses</a></li><li><a href="global.html#handleGetClasses">handleGetClasses</a></li><li><a href="global.html#handleGetCourseContent">handleGetCourseContent</a></li><li><a href="global.html#handleGetCourses">handleGetCourses</a></li><li><a href="global.html#handleUserData">handleUserData</a></li><li><a href="global.html#isBefore">isBefore</a></li><li><a href="global.html#isBeforeNow">isBeforeNow</a></li><li><a href="global.html#item">item</a></li><li><a href="global.html#makeDateFrom">makeDateFrom</a></li><li><a href="global.html#mapCourseContent">mapCourseContent</a></li><li><a href="global.html#millisecondsUntil">millisecondsUntil</a></li><li><a href="global.html#minutesUntil">minutesUntil</a></li><li><a href="global.html#selectRolesData">selectRolesData</a></li><li><a href="global.html#selectUserId">selectUserId</a></li><li><a href="global.html#sendGoogleUserData">sendGoogleUserData</a></li><li><a href="global.html#sendToken">sendToken</a></li><li><a href="global.html#timeLeftFormat">timeLeftFormat</a></li><li><a href="global.html#useRoles">useRoles</a></li><li><a href="global.html#useSearchQuery">useSearchQuery</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.0</a> on Thu Nov 17 2022 15:23:45 GMT+0530 (India Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
